<link rel="import" href="../../packages/polymer/polymer.html">
<polymer-element name="earth-globe">
  <template>
    <style>
      :host {
        display: block;
        float: left;
      }
      .water {
  fill: #00248F;
}
.land {
  fill: #A98B6F;
  stroke: #FFF;
  stroke-width: 0.7px;
}
.land:hover {
  fill: #33CC33;
  stroke-width: 1px;
}
.clicked {
  fill: #59574B;
}
.selected {
  fill: cyan;
}
.selected:hover {
  fill: cyan;
}
.focused {
  fill: #33CC33;
}
select {
  display: none;
}
svg {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
.countryTooltip {
  background: #fff;
  border: solid #ccc 1px;
  color: #666;
  display: none;
  font-size: 14px;
  font-family: sans-serif;
  padding: 5px;
  pointer-events: none;
  position: absolute;
  text-align: left;
}
    </style>
    <!--svg id="svg"></svg -->
    <content></content>   
  </template>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script>  
  function loadEarth() {
      //610x610 scale 300 works perfectly.
      var width = 610, height = 610, sens = 0.25, focused;
      var projection = d3.geo.orthographic().scale(300).rotate([0, 0]).translate([width / 2, height / 2]).clipAngle(90);
      var path = d3.geo.path().projection(projection); 
      //var internal = document.querySelector('#earth-globe');      //SVG container    
      //var svg = d3.select("#svg").attr("width", width).attr("height", height);
      var svg = d3.select("#frontandcenter").insert("svg", ":first-child").attr("width", width).attr("height", height);
      svg.append("path").datum({type: "Sphere"}).attr("class", "water").attr("d", path);      //Adding water
      var countryTooltip = d3.select("#frontandcenter").append("div").attr("class", "countryTooltip"), countryList = d3.select("body").append("select").attr("id", "countrylist").attr("name", "countries");
      queue().defer(d3.json, "data/world.json").defer(d3.tsv, "data/countries.tsv").await(ready);
      function ready(error, world, countryData) {
        var countryById = {},
        countries = topojson.feature(world, world.objects.countries).features;
        //Adding countries to select
        countryData.forEach(function(d) {
          countryById[d.id] = d.name;
          option = countryList.append("option");
          option.text(d.name);
          option.property("value", d.id);
        });
        //Drawing countries on the globe
        var world = svg.selectAll("path.land").data(countries).enter().append("path").attr("class", "land").attr("d", path)
        .on("mouseout", function(d) {
          countryTooltip.style("opacity", 0).style("display", "none");
        })
        .on("mousemove", function(d) {
          countryTooltip.style("left", (d3.event.pageX + 7) + "px").style("top", (d3.event.page - 15) + "px");
        })
        .on("click", function(d) {
          var paths = document.getElementsByTagName('path');
          for (j = 0; j < paths.length; j++) paths[j].classList.remove('selected');
          d3.select(this).attr("class", "land selected");
        })
        .on("wheel.zoom", function(d) {
          d3.geo.orthographic().scale(30);
        });
        //Drag event
        svg.selectAll("path").call(d3.behavior.drag().origin(function() { var r = projection.rotate(); return {x: r[0] / sens, y: -r[1] / sens}; })
          .on("drag", function() {
            projection.rotate([d3.event.x * sens, -d3.event.y * sens, projection.rotate()[2]]);
            svg.selectAll("path.land").attr("d", path);
            svg.selectAll(".focused").classed("focused", focused = false);
          }))
        //Country focus on option select
        d3.select("select").on("change", function() {
          var focusedCountry = country(countries, this),
          p = d3.geo.centroid(focusedCountry);
          svg.selectAll(".focused").classed("focused", focused = false);
        //Globe rotating
        (function transition() {
          d3.transition()
          .duration(1500)
          .tween("rotate", function() {
            var r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
            return function(t) {
              projection.rotate(r(t));
              svg.selectAll("path").attr("d", path).classed("focused", function(d, i) { return d.id == focusedCountry.id ? focused = d : false; });
            };
          })
          })();
        });
        function country(cnt, sel) {
          for (var i = 0, l = cnt.length; i < l; i++) if (cnt[i].id == sel.value) return cnt[i];
        };
      }; 
  }
  </script>
  <script type="application/dart" src="earth_globe.dart"></script>
</polymer-element>
